FROM continuumio/miniconda3

RUN apt-get -qq update --yes \
 && apt-get -qq install --yes --no-install-recommends \
    build-essential git make clang libboost-dev postgresql-client ca-certificates \
    curl gpg-agent gnupg2 apt-transport-https \
 && rm -rf /var/lib/apt/lists/*

# MSSQL Driver Setup
ENV ACCEPT_EULA=Y

RUN curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add - \
 && curl https://packages.microsoft.com/config/debian/10/prod.list > /etc/apt/sources.list.d/mssql-release.list \
 && apt-get -qq update --yes \
 && apt-get install --yes --no-install-recommends \
    build-essential git make clang libboost-dev postgresql-client ca-certificates \
    msodbcsql17 \
 && rm -rf /var/lib/apt/lists/*

ARG PYTHON_VERSION
ADD ci/requirements-$PYTHON_VERSION-dev.yml /

RUN /opt/conda/bin/conda config --add channels conda-forge \
  && /opt/conda/bin/conda update --all --yes --quiet \
  && /opt/conda/bin/conda install --yes conda-build \
  && /opt/conda/bin/conda clean --all --yes

RUN /opt/conda/bin/conda env create --name ibis-env --file /requirements-$PYTHON_VERSION-dev.yml \
  && /opt/conda/bin/conda clean --all --yes

RUN echo 'source /opt/conda/bin/activate ibis-env && exec "$@"' > activate.sh

COPY . /ibis
WORKDIR /ibis

RUN bash /activate.sh pip install -e . --no-deps --ignore-installed --no-cache-dir

ENTRYPOINT ["bash", "/activate.sh"]
